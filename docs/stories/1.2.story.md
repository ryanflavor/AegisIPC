# Story 1.2: 服务实例的基础注册与发现

## Status
Approved

## Story
**As a** 服务实例,
**I want** 能够向中央路由组件注册我的服务名和实例ID,
**so that** 系统能够知道我的存在。

## Acceptance Criteria
1. 服务实例启动时能成功注册信息。
2. 中央组件能存储和管理在线服务实例信息。
3. 可通过管理接口查询已注册的服务列表。

## Tasks / Subtasks
- [ ] Task 1: 定义服务注册的域模型和数据契约 (AC: 1, 2)
  - [ ] Subtask 1.1: 在 `domain/` 层创建 Service 和 ServiceInstance 实体
  - [ ] Subtask 1.2: 使用 Pydantic v2 定义服务注册请求/响应模型
  - [ ] Subtask 1.3: 定义服务状态枚举（ONLINE, OFFLINE, UNHEALTHY）
  - [ ] Subtask 1.4: 创建服务注册相关的域异常类
- [ ] Task 2: 实现服务注册的核心逻辑 (AC: 1, 2)
  - [ ] Subtask 2.1: 在 `application/` 层创建 ServiceRegistry 应用服务
  - [ ] Subtask 2.2: 实现服务注册方法，包含重复注册检查
  - [ ] Subtask 2.3: 实现内存中的服务实例存储（后续可扩展为持久化）
  - [ ] Subtask 2.4: 添加结构化日志记录所有注册事件
- [ ] Task 3: 创建 NATS 基础设施层集成 (AC: 1)
  - [ ] Subtask 3.1: 在 `infrastructure/` 创建 NATS 客户端连接管理
  - [ ] Subtask 3.2: 实现基于 NATS 的服务注册 RPC 处理器
  - [ ] Subtask 3.3: 使用 MessagePack 进行消息序列化/反序列化
  - [ ] Subtask 3.4: 实现重试和错误处理机制
- [ ] Task 4: 开发管理 API 接口 (AC: 3)
  - [ ] Subtask 4.1: 在 `api/` 层创建 REST 管理端点
  - [ ] Subtask 4.2: 实现 GET /services 端点返回所有注册服务
  - [ ] Subtask 4.3: 实现 GET /services/{service_name} 查询特定服务
  - [ ] Subtask 4.4: 添加 API 文档和错误响应处理
- [ ] Task 5: 在 Client SDK 中实现服务注册客户端 (AC: 1)
  - [ ] Subtask 5.1: 创建 ServiceClient 类封装注册逻辑
  - [ ] Subtask 5.2: 实现自动重试和连接管理
  - [ ] Subtask 5.3: 提供简单的注册 API 接口 (`async def register(service_name: str, instance_id: str, metadata: dict = None)`)
  - [ ] Subtask 5.4: 添加配置选项（超时、重试策略等）
- [ ] Task 6: 编写单元和集成测试 (AC: 1, 2, 3)
  - [ ] Subtask 6.1: 为域模型编写单元测试
  - [ ] Subtask 6.2: 为 ServiceRegistry 编写单元测试（使用 mock）
  - [ ] Subtask 6.3: 编写 NATS 集成测试（使用 Docker Compose）
  - [ ] Subtask 6.4: 编写 REST API 端到端测试
  - [ ] Subtask 6.5: 确保测试覆盖率达到 80% 以上

## Dev Notes

### Previous Story Insights
从 Story 1.1 的实现中，以下基础设施已经就位：
- 完整的项目结构，遵循六边形架构模式
- 日志基础设施：`/packages/ipc_router/ipc_router/infrastructure/logging.py`
- 异常层次结构：`/packages/ipc_router/ipc_router/domain/exceptions.py`
- 错误处理模式：`/packages/ipc_router/ipc_router/application/error_handling.py`
- Docker Compose 配置，包含 NATS JetStream 服务
- 完整的 CI/CD 管道和代码质量检查工具

### Data Models
**服务注册数据模型需求**：
- 所有跨服务数据必须首先定义为 Pydantic 模型 [Source: architecture/8-错误处理与编码规范.md#契约优先]
- 模型应包含验证规则并支持 MessagePack 序列化
- 建议的服务注册模型字段：
  ```python
  service_name: str  # 服务名称
  instance_id: str   # 实例唯一标识符
  timestamp: datetime  # 注册时间戳
  metadata: dict[str, Any]  # 可选的元数据
  ```

### API Specifications
**NATS RPC 模式**：
- 使用 NATS Request-Reply 模式进行服务注册
- Subject 命名约定：`ipc.service.register`
- 消息格式：MessagePack 序列化的 Pydantic 模型
- 超时设置：默认 5 秒
- 错误场景处理：
  - 重复注册：返回 409 Conflict 状态，包含已存在的实例信息
  - 无效数据：返回 400 Bad Request，包含验证错误详情
  - 连接失败：自动重试 3 次，使用指数退避策略
  - 超时：返回 504 Gateway Timeout 错误

**REST 管理 API**：
- 基础路径：`/api/v1/admin`
- 端点：
  - `GET /api/v1/admin/services` - 列出所有服务
  - `GET /api/v1/admin/services/{service_name}` - 查询特定服务详情

### Component Specifications
No specific UI components required for this story - this is a backend-only implementation.

### File Locations
基于项目结构，新代码应创建在以下位置：
```
packages/ipc_router/ipc_router/
├── domain/
│   ├── entities/
│   │   ├── service.py         # Service 和 ServiceInstance 实体
│   │   └── __init__.py
│   └── exceptions.py          # 添加服务注册相关异常
├── application/
│   ├── services/
│   │   ├── service_registry.py  # ServiceRegistry 应用服务
│   │   └── __init__.py
│   └── error_handling.py      # 使用现有的错误处理装饰器
├── infrastructure/
│   ├── messaging/
│   │   ├── nats_client.py     # NATS 客户端管理
│   │   ├── handlers/
│   │   │   ├── registration_handler.py  # 注册 RPC 处理器
│   │   │   └── __init__.py
│   │   └── __init__.py
│   └── logging.py             # 使用现有的日志配置
└── api/
    ├── admin/
    │   ├── services_api.py    # 服务管理 REST 端点
    │   └── __init__.py
    └── __init__.py

packages/ipc_client_sdk/ipc_client_sdk/
├── clients/
│   ├── service_client.py      # 服务注册客户端
│   └── __init__.py
└── models/
    ├── service_models.py      # 共享的 Pydantic 模型
    └── __init__.py
```
[Source: architecture/6-代码目录结构-source-tree.md#ipc_router]

### Testing Requirements
**测试文件位置**：
- Router 单元测试：`packages/ipc_router/tests/unit/`
- Router 集成测试：`packages/ipc_router/tests/integration/`
- SDK 测试：`packages/ipc_client_sdk/tests/`
[Source: architecture/6-代码目录结构-source-tree.md#packages]

**测试标准**：
- 使用 Pytest 作为测试框架 [Source: architecture/3-技术栈-tech-stack.md#测试框架]
- 使用 pytest-asyncio 进行异步测试
- 使用 pytest-mock 进行 mock 测试
- 遵循分层测试策略：单元测试、集成测试 [Source: architecture/7-测试与部署策略.md#测试策略]
- 集成测试使用 Docker Compose 运行真实的 NATS 实例
- 代码覆盖率最低 80%，使用 pytest-cov

**本故事的具体测试要求**：
- 域模型的单元测试（验证、序列化）
- ServiceRegistry 的单元测试（使用 mock 存储）
- NATS 消息处理的集成测试
- REST API 的端到端测试
- 客户端 SDK 的集成测试
- 验证服务能成功注册并获得确认
- 验证重复注册的处理（幂等性）
- 验证服务列表查询的正确性
- 验证错误情况的处理（网络故障、无效数据等）
- 验证并发注册的线程安全性

### Technical Constraints
- Python 3.13 [Source: architecture/3-技术栈-tech-stack.md#开发语言]
- 100% 类型注解要求
- 所有公共 API 需要完整的文档字符串
- 所有 I/O 操作必须使用 async/await 模式
- 所有远程调用必须包装在 try/except 块中 [Source: architecture/8-错误处理与编码规范.md#显式错误处理]
- 使用已建立的错误处理模式（重试、断路器）[Source: Story 1.1 completion notes]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-21 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-21 | 1.1 | Fixed source reference error and improved structure based on validation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List


## QA Results
