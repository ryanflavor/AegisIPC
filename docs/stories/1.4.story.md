# Story 1.4: 实现基于资源的精确目标路由

## Status
Draft

## Story
**As a** 调用方,
**I want** 将一个请求发送给一个特定的"资源",
**so that** 系统能将该请求精确地投递到唯一一个正在处理该资源的实例上。

## Acceptance Criteria
1. 服务实例能注册自己正在处理一个或多个"资源ID"。
2. 一个"资源ID"在同一时间只能被一个实例注册。
3. 包含"资源ID"的请求被精确路由到对应的实例。
4. 若请求的"资源ID"无实例处理，则返回明确错误。

## Tasks / Subtasks
- [ ] Task 1: 设计并实现资源管理的领域模型 (AC: 1, 2)
  - [ ] Subtask 1.1: 在 `domain/entities/` 创建 Resource 实体类
  - [ ] Subtask 1.2: 在 `domain/interfaces/` 创建 ResourceManager 抽象接口
  - [ ] Subtask 1.3: 定义资源冲突和资源未找到的领域异常
  - [ ] Subtask 1.4: 实现资源所有权的验证逻辑
- [ ] Task 2: 扩展 ServiceRegistry 支持资源注册 (AC: 1, 2)
  - [ ] Subtask 2.1: 添加 register_resource 方法用于资源注册
  - [ ] Subtask 2.2: 添加 release_resource 方法用于资源释放
  - [ ] Subtask 2.3: 实现资源唯一性约束的并发安全检查
  - [ ] Subtask 2.4: 添加 get_resource_owner 方法查询资源所有者
  - [ ] Subtask 2.5: 实现实例离线时自动释放其所有资源
- [ ] Task 3: 创建资源服务层组件 (AC: 1, 2, 4)
  - [ ] Subtask 3.1: 在 `application/services/` 创建 ResourceService
  - [ ] Subtask 3.2: 实现资源注册的业务逻辑和冲突处理
  - [ ] Subtask 3.3: 实现资源释放的业务逻辑
  - [ ] Subtask 3.4: 添加资源状态查询功能
  - [ ] Subtask 3.5: 集成事件通知机制用于资源变更
- [ ] Task 4: 扩展路由服务支持资源路由 (AC: 3, 4)
  - [ ] Subtask 4.1: 修改 RoutingService 添加资源路由逻辑
  - [ ] Subtask 4.2: 实现基于 resource_id 的精确路由选择
  - [ ] Subtask 4.3: 处理资源未找到的错误情况
  - [ ] Subtask 4.4: 添加资源路由的详细日志记录
- [ ] Task 5: 实现 NATS 资源管理处理器 (AC: 1, 2)
  - [ ] Subtask 5.1: 创建 ResourceHandler 处理资源注册/释放请求
  - [ ] Subtask 5.2: 实现资源注册的 NATS 消息处理
  - [ ] Subtask 5.3: 实现资源释放的 NATS 消息处理
  - [ ] Subtask 5.4: 处理并发资源注册的冲突
- [ ] Task 6: 扩展 Client SDK 支持资源操作 (AC: 1, 3)
  - [ ] Subtask 6.1: 添加 register_resource 方法到 ServiceClient
  - [ ] Subtask 6.2: 添加 release_resource 方法到 ServiceClient
  - [ ] Subtask 6.3: 修改 call 方法支持可选的 resource_id 参数
  - [ ] Subtask 6.4: 实现资源相关错误的客户端处理
- [ ] Task 7: 创建资源路由的 Pydantic 模型 (AC: 1, 3)
  - [ ] Subtask 7.1: 定义 ResourceRegistration 请求/响应模型
  - [ ] Subtask 7.2: 定义 ResourceRelease 请求/响应模型
  - [ ] Subtask 7.3: 扩展 RouteRequest/Response 添加 resource_id 字段
  - [ ] Subtask 7.4: 创建资源相关的错误响应模型
- [ ] Task 8: 编写全面的测试套件 (AC: 1, 2, 3, 4)
  - [ ] Subtask 8.1: 为资源管理编写单元测试
  - [ ] Subtask 8.2: 测试资源唯一性约束和并发冲突
  - [ ] Subtask 8.3: 测试资源路由的准确性
  - [ ] Subtask 8.4: 测试实例离线时的资源自动释放
  - [ ] Subtask 8.5: 编写端到端的资源路由集成测试
  - [ ] Subtask 8.6: 确保测试覆盖率达到 80% 以上

## Dev Notes

### Previous Story Insights
从 Story 1.3 的实现中，以下组件可以复用和扩展：
- ServiceRegistry: 已实现服务实例的存储和管理，需扩展以支持资源注册
- RoutingService: 已实现基于服务名的路由，需增强支持资源路由
- NATSClient: 已建立的 NATS 消息传递基础设施
- RouteRequestHandler: 已实现请求路由，需扩展处理资源路由
- 完整的异常层次结构（可添加资源相关异常）
- MessagePack 序列化/反序列化机制
- 结构化日志和分布式追踪基础设施

### Data Models
**资源实体模型**：
```python
# domain/entities/resource.py
class Resource:
    resource_id: str          # 全局唯一的资源标识符
    owner_instance_id: str    # 拥有该资源的实例ID
    service_name: str         # 资源所属的服务名
    registered_at: datetime   # 注册时间（UTC）
    metadata: dict[str, Any]  # 可选的资源元数据
```

**资源注册请求模型** [Source: architecture/8-错误处理与编码规范.md#契约优先]：
```python
# application/models/resource_models.py
class ResourceRegistrationRequest(BaseModel):
    service_name: str
    instance_id: str
    resource_ids: list[str]    # 要注册的资源ID列表
    force: bool = False        # 是否强制覆盖现有注册
    metadata: dict[str, Any] = {}
    trace_id: str

class ResourceRegistrationResponse(BaseModel):
    success: bool
    registered: list[str]      # 成功注册的资源ID
    conflicts: dict[str, str]  # 冲突的资源ID及其当前所有者
    trace_id: str
```

**扩展的路由请求模型**：
```python
# 扩展现有的 RouteRequest
class RouteRequest(BaseModel):
    service_name: str
    resource_id: Optional[str] = None  # 新增：资源ID（可选）
    method: str
    params: dict[str, Any]
    timeout: float
    trace_id: str
```

### API Specifications
**NATS 资源管理模式**：
- 资源注册 Subject: `ipc.resource.register`
- 资源释放 Subject: `ipc.resource.release`
- 资源查询 Subject: `ipc.resource.query`
- 使用 Request-Reply 模式进行同步操作
- 消息格式：MessagePack 序列化的 Pydantic 模型

**资源路由工作流程** [Source: architecture/5-核心工作流-core-workflows.md]：
1. 服务实例启动时注册其管理的资源
2. 系统验证资源未被其他实例占用
3. 客户端发送包含 resource_id 的请求
4. 路由服务查询资源所有者
5. 请求直接转发到拥有该资源的实例
6. 实例离线时自动释放其所有资源

### Component Specifications
No UI components required - this is a backend resource routing implementation.

### File Locations
基于项目结构，新代码应创建在以下位置 [Source: architecture/6-代码目录结构-source-tree.md]:
```
packages/ipc_router/ipc_router/
├── domain/
│   ├── entities/
│   │   ├── resource.py          # Resource 实体类
│   │   └── __init__.py
│   └── interfaces/
│       ├── resource_manager.py  # ResourceManager 抽象接口
│       └── __init__.py
├── application/
│   ├── services/
│   │   ├── resource_service.py  # ResourceService 应用服务
│   │   └── __init__.py
│   └── models/
│       ├── resource_models.py   # 资源相关的 Pydantic 模型
│       └── __init__.py
├── infrastructure/
│   └── messaging/
│       └── handlers/
│           ├── resource_handler.py # ResourceHandler
│           └── __init__.py
└── api/
    └── admin/
        ├── resource_api.py       # 资源管理 REST 端点
        └── __init__.py

packages/ipc_client_sdk/ipc_client_sdk/
├── clients/
│   └── service_client.py        # 扩展添加资源方法
└── models/
    └── resource_models.py       # 共享的资源 Pydantic 模型
```

### Testing Requirements
**测试文件位置**：
- Router 单元测试：`packages/ipc_router/tests/unit/`
- Router 集成测试：`packages/ipc_router/tests/integration/`
- SDK 测试：`packages/ipc_client_sdk/tests/`

**测试框架和工具** [Source: architecture/3-技术栈-tech-stack.md#测试框架]：
- Pytest 作为主测试框架
- pytest-asyncio 用于异步测试
- pytest-mock 用于 mock 和 stub
- pytest-cov 用于覆盖率报告

**本故事的具体测试要求** [Source: architecture/9-测试要求标准.md]：
- 资源唯一性约束的并发测试
- 资源冲突处理的正确性测试
- 资源路由的准确性测试
- 实例故障时资源自动释放测试
- 端到端的资源注册和路由测试
- 性能测试：验证资源查找的 O(1) 性能

### Technical Constraints
- Python 3.13+ [Source: architecture/3-技术栈-tech-stack.md#开发语言]
- 100% 类型注解覆盖率
- 所有 I/O 操作必须使用 async/await [Source: architecture/8-错误处理与编码规范.md#异步编程规范]
- 使用 asyncio.Lock 确保资源注册的原子性
- 遵循已建立的错误处理模式
- 所有日志必须包含 trace_id 和 resource_id
- 性能目标：资源查找 < 1ms，注册/释放 < 5ms

### Error Handling Specifications
**资源相关错误处理**：

1. **资源冲突错误 (ResourceConflictError)**
   - 错误码：409 Conflict
   - 场景：尝试注册已被占用的资源
   - 响应：返回当前所有者的 instance_id
   - 处理：客户端可选择等待或使用其他资源

2. **资源未找到错误 (ResourceNotFoundError)**
   - 错误码：404 Not Found
   - 场景：请求的资源无实例处理
   - 响应：返回请求的 resource_id
   - 监控：记录未找到的资源请求频率

3. **资源释放错误 (ResourceReleaseError)**
   - 错误码：403 Forbidden
   - 场景：尝试释放不属于自己的资源
   - 响应：返回资源的真实所有者
   - 安全：防止恶意释放他人资源

4. **资源注册超限错误 (ResourceLimitExceededError)**
   - 错误码：429 Too Many Requests
   - 场景：单个实例注册过多资源
   - 配置：max_resources_per_instance = 1000
   - 处理：建议实例进行资源分片

### Resource Lifecycle Management
**资源生命周期**：
1. **注册阶段**
   - 验证实例身份和健康状态
   - 检查资源唯一性约束
   - 原子性地创建资源-实例映射
   - 发布 ResourceRegistered 事件

2. **使用阶段**
   - 高效的 O(1) 资源查找
   - 请求路由到资源所有者
   - 监控资源使用频率

3. **释放阶段**
   - 验证释放者是资源所有者
   - 原子性地删除映射
   - 发布 ResourceReleased 事件

4. **自动清理**
   - 实例心跳超时触发清理
   - 批量释放实例的所有资源
   - 记录清理事件用于审计

### Monitoring and Observability
**资源管理指标**：
```python
# Prometheus 格式指标
ipc_resource_registrations_total{service_name, status}
ipc_resource_releases_total{service_name, reason}
ipc_resource_conflicts_total{service_name, resource_id}
ipc_resource_lookups_total{service_name, found}
ipc_resources_per_instance{service_name, instance_id}
ipc_resource_operation_duration_seconds{operation, quantile}
```

**分布式追踪**：
- 为每个资源操作创建 span
- 记录资源 ID 和操作类型
- 追踪资源冲突和重试
- 关联资源操作和后续路由

**结构化日志**：
```json
{
  "timestamp": "2025-07-22T10:00:00Z",
  "level": "INFO",
  "trace_id": "abc123",
  "resource_id": "user-123",
  "instance_id": "user-service-1",
  "operation": "register",
  "duration_ms": 2.5,
  "message": "Resource registered successfully"
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-22 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
