# Story 2.1: Service Instance Heartbeat and Health Check Implementation

## Status
Draft

## Story
**As a** central routing component,
**I want** to receive periodic heartbeats from all service instances,
**so that** I can accurately detect failed instances.

## Acceptance Criteria
1. Service instances automatically send periodic heartbeats
2. Central component marks instances as "unhealthy" based on heartbeat timeout
3. "Unhealthy" instances are removed from the routing pool
4. Failover is triggered when the "active" instance becomes unhealthy

## Tasks / Subtasks
- [ ] **Task 1: Implement Heartbeat Message Protocol** (AC: 1)
  - [ ] Define heartbeat message structure in Pydantic models
  - [ ] Add heartbeat interval configuration (default: 5 seconds)
  - [ ] Create heartbeat topic structure in NATS

- [ ] **Task 2: Create HeartbeatService in ipc_router** (AC: 1, 2)
  - [ ] Implement heartbeat reception handler
  - [ ] Track last heartbeat timestamp per service instance
  - [ ] Create background task to check heartbeat timeouts

- [ ] **Task 3: Integrate Heartbeat Sending in ServiceClient SDK** (AC: 1)
  - [ ] Add automatic heartbeat sender when service registers
  - [ ] Handle heartbeat sending in background asyncio task
  - [ ] Allow configuration of heartbeat interval

- [ ] **Task 4: Implement Health Status Management** (AC: 2, 3)
  - [ ] Add health status field to ServiceInstance entity
  - [ ] Create HealthMonitoringService to track instance health
  - [ ] Implement timeout detection logic (default: 3 missed heartbeats)

- [ ] **Task 5: Update Routing Logic for Health-Aware Routing** (AC: 3, 4)
  - [ ] Modify RoutingService to exclude unhealthy instances
  - [ ] Implement automatic removal from routing pool
  - [ ] Add health check before routing decisions

- [ ] **Task 6: Implement Failover Trigger Mechanism** (AC: 4)
  - [ ] Detect when active instance becomes unhealthy
  - [ ] Trigger failover workflow when active fails
  - [ ] Emit failover events for monitoring

- [ ] **Task 7: Add Comprehensive Testing** (AC: 1-4)
  - [ ] Unit tests for heartbeat protocol
  - [ ] Integration tests for health monitoring
  - [ ] Failover scenario testing
  - [ ] Performance tests for heartbeat overhead

## Dev Notes

### Testing Standards
- Test files location: `packages/ipc_router/tests/unit/` and `packages/ipc_router/tests/integration/`
- Use pytest framework with async support
- Mock NATS interactions for unit tests
- Use real NATS container for integration tests
- Achieve minimum 80% code coverage
- Test edge cases: network partitions, slow heartbeats, rapid failovers

### Architecture Context
- **Heartbeat Flow**: Service instances send heartbeats to `heartbeat.<service_name>.<instance_id>` topic
- **Health Status**: Stored in memory within ipc_router's domain entities
- **Timeout Logic**: Background asyncio task checks timestamps every second
- **Failover Trigger**: HealthMonitoringService emits domain events when active instance fails

### Message Protocol
- Heartbeat messages use MessagePack envelope format
- Include: instance_id, service_name, timestamp, status, metadata
- Lightweight protocol to minimize overhead

### Integration Points
- **RoutingService**: Must check health status before routing
- **ServiceRegistry**: Must track health status per instance
- **NATS Topics**: New heartbeat topic hierarchy needed

### Configuration
- Heartbeat interval: Configurable per service (default 5s)
- Timeout threshold: Configurable (default 3 missed beats = 15s)
- Health check interval: Router checks every 1s

### Previous Story Context
- Story 1.5 implemented delivery guarantees and acknowledgments
- This story builds on top by adding liveness detection
- Health status will enhance routing decisions made in Story 1.4

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-23 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes List
*To be populated by Dev Agent*

### File List
*To be populated by Dev Agent*

## QA Results
*To be populated by QA Agent*
